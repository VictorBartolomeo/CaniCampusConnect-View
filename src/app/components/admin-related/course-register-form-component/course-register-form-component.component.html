
<p-dialog
  header="Créer un nouveau cours"
  [(visible)]="visible"
  [modal]="true"
  [closable]="true"
  [draggable]="false"
  [resizable]="false"
  styleClass="w-full max-w-2xl"
  (onHide)="closeDialog()">

  <form [formGroup]="courseForm" (ngSubmit)="onSubmit()" class="space-y-6">

    <!-- Titre -->
    <div class="field">
      <label for="title" class="block text-sm font-medium text-gray-700 mb-2">
        Titre du cours *
      </label>
      <input
        id="title"
        type="text"
        pInputText
        formControlName="title"
        placeholder="Ex: Éducation de base niveau 1"
        class="w-full"
        [class.ng-invalid]="isFieldInvalid('title')" />

      @if (isFieldInvalid('title')) {
        <small class="text-red-600 mt-1 block">
          @if (f['title'].errors?.['required']) {
            Le titre est requis
          }
          @if (f['title'].errors?.['minlength']) {
            Le titre doit contenir au moins 3 caractères
          }
          @if (f['title'].errors?.['maxlength']) {
            Le titre ne peut pas dépasser 100 caractères
          }
        </small>
      }
    </div>

    <!-- Description -->
    <div class="field">
      <label for="description" class="block text-sm font-medium text-gray-700 mb-2">
        Description
      </label>
      <textarea
        id="description"
        pInputTextarea
        formControlName="description"
        placeholder="Description optionnelle du cours..."
        rows="3"
        class="w-full"
        [class.ng-invalid]="isFieldInvalid('description')">
      </textarea>

      @if (isFieldInvalid('description')) {
        <small class="text-red-600 mt-1 block">
          La description ne peut pas dépasser 500 caractères
        </small>
      }
    </div>

    <!-- Coach et Type de cours -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <!-- Coach -->
      <div class="field">
        <label for="coach" class="block text-sm font-medium text-gray-700 mb-2">
          Coach *
        </label>
        <p-dropdown
          id="coach"
          [options]="coaches"
          formControlName="coach"
          optionLabel="label"
          optionValue="value"
          placeholder="Sélectionner un coach"
          class="w-full"
          [class.ng-invalid]="isFieldInvalid('coach')">
        </p-dropdown>

        @if (isFieldInvalid('coach')) {
          <small class="text-red-600 mt-1 block">
            Veuillez sélectionner un coach
          </small>
        }

        <!-- Debug info pour les coachs -->
        @if (coaches.length === 0) {
          <small class="text-orange-600 mt-1 block">
            <i class="pi pi-exclamation-triangle"></i>
            Aucun coach disponible. Veuillez d'abord ajouter des coachs.
          </small>
        }
      </div>

      <!-- Type de cours -->
      <div class="field">
        <label for="courseType" class="block text-sm font-medium text-gray-700 mb-2">
          Type de cours *
        </label>
        <p-dropdown
          id="courseType"
          [options]="courseTypes"
          formControlName="courseType"
          optionLabel="label"
          optionValue="value"
          placeholder="Sélectionner un type"
          class="w-full"
          [class.ng-invalid]="isFieldInvalid('courseType')">
        </p-dropdown>

        @if (isFieldInvalid('courseType')) {
          <small class="text-red-600 mt-1 block">
            Veuillez sélectionner un type de cours
          </small>
        }
      </div>
    </div>

    <!-- Dates - Version corrigée sans appendTo -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <!-- Date/heure de début -->
      <div class="field">
        <label for="startDatetime" class="block text-sm font-medium text-gray-700 mb-2">
          Date et heure de début *
        </label>
        <p-calendar
          id="startDatetime"
          formControlName="startDatetime"
          [showTime]="true"
          [minDate]="minDate"
          dateFormat="dd/mm/yy"
          hourFormat="24"
          placeholder="Sélectionner la date"
          class="w-full"
          [class.ng-invalid]="isFieldInvalid('startDatetime')"
          (onSelect)="onStartDateChange()"
          [touchUI]="false"
          [appendTo]="'body'">
        </p-calendar>

        @if (isFieldInvalid('startDatetime')) {
          <small class="text-red-600 mt-1 block">
            La date de début est requise
          </small>
        }
      </div>

      <!-- Date/heure de fin -->
      <div class="field">
        <label for="endDatetime" class="block text-sm font-medium text-gray-700 mb-2">
          Date et heure de fin *
        </label>
        <p-calendar
          id="endDatetime"
          formControlName="endDatetime"
          [showTime]="true"
          [minDate]="minDate"
          dateFormat="dd/mm/yy"
          hourFormat="24"
          placeholder="Sélectionner la date"
          class="w-full"
          [class.ng-invalid]="isFieldInvalid('endDatetime')"
          [touchUI]="false"
          [appendTo]="'body'">
        </p-calendar>

        @if (isFieldInvalid('endDatetime')) {
          <small class="text-red-600 mt-1 block">
            La date de fin est requise
          </small>
        }
      </div>
    </div>

    <!-- Erreurs de validation des dates -->
    @if (submitted && courseForm.errors?.['dateRangeInvalid']) {
      <div class="bg-red-50 border border-red-200 rounded-md p-3">
        <small class="text-red-600">
          La date de fin doit être postérieure à la date de début
        </small>
      </div>
    }

    @if (submitted && courseForm.errors?.['courseTooLong']) {
      <div class="bg-red-50 border border-red-200 rounded-md p-3">
        <small class="text-red-600">
          Un cours ne peut pas durer plus de 24 heures
        </small>
      </div>
    }

    <!-- Capacité maximale -->
    <div class="field">
      <label for="maxCapacity" class="block text-sm font-medium text-gray-700 mb-2">
        Capacité maximale *
      </label>
      <p-inputNumber
        id="maxCapacity"
        formControlName="maxCapacity"
        [min]="1"
        [max]="50"
        placeholder="Nombre de participants"
        class="w-full"
        [class.ng-invalid]="isFieldInvalid('maxCapacity')">
      </p-inputNumber>

      @if (isFieldInvalid('maxCapacity')) {
        <small class="text-red-600 mt-1 block">
          @if (f['maxCapacity'].errors?.['required']) {
            La capacité maximale est requise
          }
          @if (f['maxCapacity'].errors?.['min']) {
            La capacité doit être d'au moins 1 participant
          }
          @if (f['maxCapacity'].errors?.['max']) {
            La capacité ne peut pas dépasser 50 participants
          }
        </small>
      }
    </div>

    <!-- Info de debug -->
    @if (!loading && coaches.length === 0) {
      <div class="bg-yellow-50 border border-yellow-200 rounded-md p-3">
        <div class="flex items-center">
          <i class="pi pi-info-circle text-yellow-600 text-sm mr-2"></i>
          <div class="text-sm text-yellow-800">
            <p class="font-medium">Aucun coach disponible</p>
            <p class="mt-1">Vous devez d'abord créer des coachs avant de pouvoir créer des cours.</p>
          </div>
        </div>
      </div>
    }

  </form>

  <ng-template pTemplate="footer">
    <div class="flex justify-end gap-3">
      <button
        pButton
        label="Annuler"
        icon="pi pi-times"
        class="p-button-secondary"
        (click)="closeDialog()"
        [disabled]="loading">
      </button>
      <button
        pButton
        label="Créer le cours"
        icon="pi pi-check"
        class="p-button-primary"
        (click)="onSubmit()"
        [disabled]="loading || coaches.length === 0"
        [loading]="loading">
      </button>
    </div>
  </ng-template>

</p-dialog>
