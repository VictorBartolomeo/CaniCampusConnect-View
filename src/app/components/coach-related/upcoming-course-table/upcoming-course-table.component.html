<div class="p-6 bg-gray-50 dark:bg-gray-800 rounded-lg shadow-md">
  <h2 class="text-2xl font-semibold mb-6 text-gray-800 dark:text-gray-100">Mes prochains cours</h2>

  @if (isLoading) {
    <div class="flex justify-center items-center py-10">
      <i class="pi pi-spin pi-spinner text-blue-500 dark:text-blue-400" style="font-size: 2rem"></i>
      <span class="ml-2 text-gray-600 dark:text-gray-300">Chargement des cours...</span>
    </div>
  } @else if (error) {
    <div class="p-4 mb-4 text-sm text-red-700 bg-red-100 rounded-lg dark:bg-red-200 dark:text-red-800" role="alert">
      {{ error }}
    </div>
  } @else if (upcomingCourses.length === 0) {
    <div class="p-4 text-center text-gray-500 dark:text-gray-400">
      Aucun cours à venir pour le moment.
    </div>
  } @else {
    <p-table
      [value]="upcomingCourses"
      dataKey="id"
      styleClass="p-datatable-striped p-datatable-responsive-stack"
      [tableStyle]="{'min-width': '50rem'}"
      [expandedRowKeys]="expandedRows"
      responsiveLayout="stack"
      breakpoint="960px">

      <ng-template pTemplate="header">
        <tr class="bg-gray-100 dark:bg-gray-700">
          <th style="width: 3rem" class="p-3 text-left text-sm font-semibold text-gray-600 dark:text-gray-300 uppercase"></th>
          <th class="p-3 text-left text-sm font-semibold text-gray-600 dark:text-gray-300 uppercase">Titre</th>
          <th class="p-3 text-left text-sm font-semibold text-gray-600 dark:text-gray-300 uppercase">Date et Heure</th>
          <th class="p-3 text-left text-sm font-semibold text-gray-600 dark:text-gray-300 uppercase">Type</th>
          <th class="p-3 text-center text-sm font-semibold text-gray-600 dark:text-gray-300 uppercase">Inscriptions (Confirmées/Max)</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-course let-expanded="expanded">
        <tr class="border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50">
          <td class="p-3">
            <button type="button" pButton pRipple [pRowToggler]="course"
                    class="p-button-text p-button-rounded p-button-plain text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-600"
                    [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"></button>
          </td>
          <td class="p-3">
            <span class="p-column-title text-gray-600 dark:text-gray-300 font-semibold md:hidden">Titre: </span>
            <span class="text-gray-800 dark:text-gray-100">{{ course.title }}</span>
          </td>
          <td class="p-3">
            <span class="p-column-title text-gray-600 dark:text-gray-300 font-semibold md:hidden">Date et Heure: </span>
            <span class="text-gray-700 dark:text-gray-200">
              {{ course.startDatetime | date:'EEEE d MMMM yyyy':'':'fr' }}<br>
              {{ course.startDatetime | date:'HH:mm' }} - {{ course.endDatetime | date:'HH:mm' }}
            </span>
          </td>
          <td class="p-3">
            <span class="p-column-title text-gray-600 dark:text-gray-300 font-semibold md:hidden">Type: </span>
            <span class="text-gray-700 dark:text-gray-200">{{ course.courseType?.name }}</span>
          </td>
          <td class="p-3 text-center">
            <span class="p-column-title text-gray-600 dark:text-gray-300 font-semibold md:hidden">Inscriptions: </span>
            <span class="text-gray-700 dark:text-gray-200">
              {{ getConfirmedRegistrationsCount(course) }} / {{ course.maxCapacity }}
            </span>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="rowexpansion" let-course>
        <tr class="bg-gray-50 dark:bg-gray-700/30">
          <td colspan="5" class="p-0">
            <div class="p-4 border-t border-gray-200 dark:border-gray-600">
              <h4 class="text-lg font-medium mb-3 text-gray-700 dark:text-gray-200">Inscriptions pour "{{ course.title }}"</h4>

              @if (getRegistrationsToManage(course).length > 0) {
                <div class="overflow-x-auto">
                  <table class="min-w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg">
                    <thead>
                    <tr class="bg-gray-100 dark:bg-gray-700">
                      <th class="py-2 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Chien</th>
                      <th class="py-2 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">N° Puce</th>
                      <th class="py-2 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Propriétaire</th>
                      <th class="py-2 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Statut</th>
                      <th class="py-2 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Action</th>
                    </tr>
                    </thead>
                    <tbody>
                      @for (registration of getRegistrationsToManage(course); track registration.id) {
                        <tr class="border-b border-gray-200 dark:border-gray-700">
                          <td class="py-2 px-4 text-sm text-gray-700 dark:text-gray-300">{{ registration.dog?.name || 'N/A' }}</td>
                          <td class="py-2 px-4 text-sm text-gray-700 dark:text-gray-300">{{ registration.dog?.chipNumber || 'N/A' }}</td>
                          <td class="py-2 px-4 text-sm text-gray-700 dark:text-gray-300">
                            {{ registration.dog?.owner?.firstname || '' }} {{ registration.dog?.owner?.lastname || '' }}
                          </td>
                          <td class="py-2 px-4">
                            <p-tag [value]="getStatusLabel(registration.status)" [severity]="getSeverityForStatus(registration.status)"></p-tag>
                          </td>
                          <td class="py-2 px-4">
                            @if (registration.status === RegistrationStatus.PENDING) {
                              <div class="flex gap-2">
                                <button pButton pRipple type="button" icon="pi pi-check"
                                        label="Confirmer"
                                        class="p-button-sm p-button-success"
                                        (click)="onRegistrationStatusChange(RegistrationStatus.CONFIRMED, registration, course)"></button>
                                <button pButton pRipple type="button" icon="pi pi-times"
                                        label="Refuser"
                                        class="p-button-sm p-button-danger"
                                        (click)="onRegistrationStatusChange(RegistrationStatus.REFUSED, registration, course)"></button>
                              </div>
                            } @else if (registration.status === RegistrationStatus.CONFIRMED) {
                              <button pButton pRipple type="button" icon="pi pi-times-circle"
                                      label="Annuler"
                                      class="p-button-sm p-button-danger p-button-outlined"
                                      (click)="onRegistrationStatusChange(RegistrationStatus.REFUSED, registration, course)"></button>
                            }
                          </td>
                        </tr>
                      }
                    </tbody>
                  </table>
                </div>
              } @else {
                <p class="text-sm text-gray-500 dark:text-gray-400 p-2">Aucune inscription à gérer pour ce cours.</p>
              }
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="5" class="text-center p-4">
            <span class="text-gray-500 dark:text-gray-400">Aucun cours à venir trouvé.</span>
          </td>
        </tr>
      </ng-template>
    </p-table>
  }
</div>
