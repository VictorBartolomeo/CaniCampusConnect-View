<div class="p-6 bg-gray-50 dark:bg-gray-800 rounded-lg shadow-md">
  <h2 class="text-2xl font-semibold mb-6 text-gray-800 dark:text-gray-100">Mes prochains cours</h2>

  @if (isLoading) {
    <div class="flex justify-center items-center py-10">
      <i class="pi pi-spin pi-spinner text-blue-500 dark:text-blue-400" style="font-size: 2rem"></i>
      <span class="ml-2 text-gray-600 dark:text-gray-300">Chargement des cours...</span>
    </div>
  } @else if (error) {
    <div class="p-4 mb-4 text-sm text-red-700 bg-red-100 rounded-lg dark:bg-red-200 dark:text-red-800" role="alert">
      {{ error }}
    </div>
  } @else if (upcomingCourses.length === 0) {
    <div class="p-4 text-center text-gray-500 dark:text-gray-400">
      Aucun cours à venir pour le moment.
    </div>
  } @else {
    <p-table
      [value]="upcomingCourses"
      dataKey="id"
      styleClass="p-datatable-striped p-datatable-responsive-stack"
      [tableStyle]="{'min-width': '50rem'}"
      [(expandedRows)]="expandedRows"
      (onRowExpand)="onRowExpand($event)"
      (onRowCollapse)="onRowCollapse($event)"
      responsiveLayout="stack"
      breakpoint="960px">

      <ng-template pTemplate="header">
        <tr class="bg-gray-100 dark:bg-gray-700">
          <th style="width: 3rem" class="p-3 text-left text-sm font-semibold text-gray-600 dark:text-gray-300 uppercase"></th> <!-- Pour l'expandeur -->
          <th class="p-3 text-left text-sm font-semibold text-gray-600 dark:text-gray-300 uppercase">Titre</th>
          <th class="p-3 text-left text-sm font-semibold text-gray-600 dark:text-gray-300 uppercase">Date et Heure</th>
          <th class="p-3 text-left text-sm font-semibold text-gray-600 dark:text-gray-300 uppercase">Type</th>
          <th class="p-3 text-center text-sm font-semibold text-gray-600 dark:text-gray-300 uppercase">Inscriptions (Confirmées/Max)</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-course let-expanded="expanded">
        <tr class="border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50">
          <td class="p-3">
            <button type="button" pButton pRipple [pRowToggler]="course"
                    class="p-button-text p-button-rounded p-button-plain text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-600"
                    [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"></button>
          </td>
          <td class="p-3">
            <span class="p-column-title text-gray-600 dark:text-gray-300 font-semibold md:hidden">Titre: </span>
            <span class="text-gray-800 dark:text-gray-100">{{ course.title }}</span>
          </td>
          <td class="p-3">
            <span class="p-column-title text-gray-600 dark:text-gray-300 font-semibold md:hidden">Date et Heure: </span>
            <span class="text-gray-700 dark:text-gray-200">
              {{ course.startDatetime | date:'EEEE d MMMM yyyy':'':'fr' }}<br>
              {{ course.startDatetime | date:'HH:mm' }} - {{ course.endDatetime | date:'HH:mm' }}
            </span>
          </td>
          <td class="p-3">
            <span class="p-column-title text-gray-600 dark:text-gray-300 font-semibold md:hidden">Type: </span>
            <span class="text-gray-700 dark:text-gray-200">{{ course.courseType?.name }}</span>
          </td>
          <td class="p-3 text-center">
            <span class="p-column-title text-gray-600 dark:text-gray-300 font-semibold md:hidden">Inscriptions: </span>
            <span class="text-gray-700 dark:text-gray-200">
              {{ course.registrations?.filter(r => r.status === RegistrationStatus.CONFIRMED).length || 0 }} / {{ course.maxCapacity }}
            </span>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="rowexpansion" let-course>
        <tr class="bg-gray-50 dark:bg-gray-700/30">
          <td colspan="5" class="p-0"> <!-- Important: p-0 pour que la table interne prenne toute la place -->
            <div class="p-4 border-t border-gray-200 dark:border-gray-600">
              <h4 class="text-lg font-medium mb-3 text-gray-700 dark:text-gray-200">Inscriptions pour "{{ course.title }}"</h4>
              @if (getRegistrationsToManage(course).length > 0) {
                <p-table [value]="getRegistrationsToManage(course)" styleClass="p-datatable-sm" dataKey="id">
                  <ng-template pTemplate="header">
                    <tr class="bg-gray-100 dark:bg-gray-600">
                      <th class="p-2 text-left text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase">Chien</th>
                      <th class="p-2 text-left text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase">Propriétaire</th>
                      <th class="p-2 text-left text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase">Statut Actuel</th>
                      <th class="p-2 text-left text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase">Changer Statut</th>
                    </tr>
                  </ng-template>
                  <ng-template pTemplate="body" let-registration>
                    <tr class="border-b border-gray-200 dark:border-gray-600">
                      <td class="p-2 text-sm text-gray-700 dark:text-gray-200">{{ registration.dog?.name || 'N/A' }}</td>
                      <td class="p-2 text-sm text-gray-700 dark:text-gray-200">
                        {{ registration.dog?.owner?.firstname || '' }} {{ registration.dog?.owner?.lastname || '' }}
                        @if (!registration.dog?.owner) {
                          <span class="text-xs text-gray-400 italic">(Propriétaire non spécifié)</span>
                        }
                      </td>
                      <td class="p-2">
                        <p-tag [value]="getStatusLabel(registration.status)" [severity]="getSeverityForStatus(registration.status)"></p-tag>
                      </td>
                      <td class="p-2">
                        @if (registration.status === RegistrationStatus.PENDING) {
                          <p-dropdown
                            [options]="statusOptions"
                            placeholder="Action..."
                            optionLabel="label"
                            optionValue="value"
                            (onChange)="onRegistrationStatusChange($event.value, registration, course)"
                            styleClass="p-dropdown-sm w-full md:w-auto"
                            [showClear]="false">
                            <ng-template let-option pTemplate="item">
                              <div class="flex items-center">
                                @if (option.icon) { <i [class]="option.icon + ' mr-2'"></i> }
                                <span>{{option.label}}</span>
                              </div>
                            </ng-template>
                          </p-dropdown>
                        } @else if (registration.status === RegistrationStatus.CONFIRMED) {
                          <button pButton pRipple type="button" icon="pi pi-times-circle"
                                  label="Annuler/Refuser"
                                  class="p-button-sm p-button-danger p-button-outlined"
                                  pTooltip="Passer à Refusé (ou Annulé par coach)"
                                  (click)="onRegistrationStatusChange(RegistrationStatus.REFUSED, registration, course)"></button>
                        } @else {
                          <span class="text-xs text-gray-400 italic">(Aucune action directe)</span>
                        }
                      </td>
                    </tr>
                  </ng-template>
                </p-table>
              } @else {
                <p class="text-sm text-gray-500 dark:text-gray-400 p-2">Aucune inscription en attente ou confirmée à gérer pour ce cours.</p>
              }
            </div>
          </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="5" class="text-center p-4">
            <span class="text-gray-500 dark:text-gray-400">Aucun cours à venir trouvé.</span>
          </td>
        </tr>
      </ng-template>
    </p-table>
  }
</div>
